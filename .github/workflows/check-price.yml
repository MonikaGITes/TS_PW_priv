name: Check Yepoda Price

on:
  schedule:
    - cron: '0 7 * * *' # codziennie o 7:00 rano
  workflow_dispatch:

jobs:
  check_price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run price checker
        run: |
          npx ts-node src/Yepoda_Dewy_Day.ts > output.log
          cat output.log
          if grep -q "ALERT" output.log; then
            echo "Triggering email..."
          else
            echo "No alert needed."
            exit 0
          fi

      - name: Send email if needed
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "üìâ Yepoda cena poni≈ºej 100z≈Ç!"
          body: "Cena na stronie yepoda.pl spad≈Ça! Sprawd≈∫ https://yepoda.pl/products/the-dewy-day"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_USER }}
          secure: true